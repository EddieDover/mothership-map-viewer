<div class="mothership-map-viewer-container">
  <div class="map-controls">
    <button
      data-action="onImportJson"
      id="import-json-btn"
      title="{{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.ImportJSON'}}"
    >
      <i class="fas fa-file-import"></i>
      {{localize "MOTHERSHIP_MAP_VIEWER.forms.viewer.ImportJSON"}}
    </button>
    <button
      data-action="onImportShareString"
      id="import-share-btn"
      title="{{localize
        'MOTHERSHIP_MAP_VIEWER.forms.viewer.ImportShareString'
      }}"
    >
      <i class="fas fa-share"></i>
      {{localize "MOTHERSHIP_MAP_VIEWER.forms.viewer.ImportShareString"}}
    </button>
    <button
      data-action="onGoToMapCreator"
      id="go-to-editor-btn"
      title="{{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.GoToMapCreator'}}"
    >
      <i class="fas fa-edit"></i>
      {{localize "MOTHERSHIP_MAP_VIEWER.forms.viewer.GoToMapCreator"}}
    </button>
    <button
      data-action="onGoToCommunityMaps"
      id="community-maps-btn"
      title="{{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.CommunityMaps'}}"
    >
      <i class="fas fa-globe"></i>
      {{localize "MOTHERSHIP_MAP_VIEWER.forms.viewer.CommunityMaps"}}
    </button>
    
    <div class="floor-controls" style="display: flex; align-items: center; margin: 0 10px;">
        <button id="floor-down-btn" title="{{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.FloorDown'}}" style="width: 30px; padding: 0;"><i class="fas fa-arrow-down"></i></button>
        <span id="currentFloorDisplay" style="margin: 0 8px; font-weight: bold;">{{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.Floor'}} 1</span>
        <button id="floor-up-btn" title="{{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.FloorUp'}}" style="width: 30px; padding: 0;"><i class="fas fa-arrow-up"></i></button>
    </div>

    <button
      id="toggle-3d-btn"
      title="{{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.Toggle3DMode'}}"
    >
      <i class="fas fa-cube"></i>
      {{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.Mode3D'}}
    </button>
    <div style="flex-grow:1"></div>
    <button
      data-action="onFeedback"
      type="button"
      class="btn btn--primary"
      style="max-width:50px"
      name="feedback"
      title="{{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.Feedback'}}"
    >
      <i class="fas fa-comment"></i>
    </button>
    <button
      data-action="onBugReport"
      type="button"
      class="btn btn--primary"
      style="max-width:50px"
      name="bugreport"
      title="{{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.BugReport'}}"
    >
      <i class="fas fa-bug"></i>
    </button>
    <button
      data-action="onDiscord"
      type="button"
      class="btn btn--primary"
      style="max-width:50px"
      name="discord"
      title="{{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.Discord'}}"
    >
      <i class="fab fa-discord"></i>
    </button>
  </div>

  {{#if hasMultipleMaps}}
    <div class="map-selector-bar">
      <label for="map-selector-dropdown">
        <i class="fas fa-map"></i>
        {{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.CurrentMap'}}:
      </label>
      <select id="map-selector-dropdown" class="map-selector-dropdown">
        {{#each maps}}
          <option value="{{this.id}}" {{#if (eq this.id ../currentMapId)}}selected{{/if}}>
            {{this.name}}
          </option>
        {{/each}}
      </select>
      <button id="delete-map-btn" class="delete-map-btn" title="{{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.DeleteCurrentMap'}}">
        <i class="fas fa-trash"></i>
        {{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.DeleteMap'}}
      </button>
    </div>
  {{/if}}

  {{#if hasMap}}
    <div class="map-view-section">
      <div class="map-content">
        <div class="canvas-container" id="map-container">
          <canvas id="map-canvas"></canvas>
        </div>
      </div>
      <div class="visibility-panel">
        <h2 id="visibility-header" class="collapsible-header">
          <i class="fas fa-chevron-down collapse-icon"></i>
          {{localize "MOTHERSHIP_MAP_VIEWER.forms.viewer.VisibilityControls"}}
        </h2>
        <div class="active-viewers-section">
          <h2>{{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.ActiveViewers'}}</h2>
          <div class="viewers-controls">
            <button
              id="show-all-players-btn"
              class="show-all-players-btn"
              title="{{localize
                'MOTHERSHIP_MAP_VIEWER.forms.viewer.ShowToPlayers'
              }}"
            >
              <i class="fas fa-users"></i>
              {{localize "MOTHERSHIP_MAP_VIEWER.forms.viewer.ShowToPlayers"}}
            </button>
            <button
              id="close-all-players-btn"
              class="close-all-players-btn"
              title="{{localize
                'MOTHERSHIP_MAP_VIEWER.forms.viewer.ClosePlayerView'
              }}"
              style="display: none"
            >
              <i class="fas fa-times"></i>
              {{localize "MOTHERSHIP_MAP_VIEWER.forms.viewer.ClosePlayerView"}}
            </button>
          </div>
          <div id="active-viewers-list" class="active-viewers-list">
            <p class="no-viewers">{{localize "MOTHERSHIP_MAP_VIEWER.forms.viewer.NoPlayersViewing"}}</p>
          </div>
        </div>
        <div class="filter-controls" style="padding: 10px 0;">
            <input type="text" id="gm-room-filter" placeholder="{{localize 'MOTHERSHIP_MAP_VIEWER.forms.viewer.FilterRooms'}}" style="width: 100%; padding: 5px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px;">
        </div>
        <div id="visibility-controls" class="visibility-controls-content"></div>
      </div>
    </div>
  {{else}}
    <p>{{localize "MOTHERSHIP_MAP_VIEWER.forms.viewer.NoMapLoaded"}}</p>
  {{/if}}
</div>